# ==================================================
# Path: E:\Dai Hoc\Nam 3\An toan mang\cert-monitor
# Detected tech: go, javascript
# ==================================================

## DIRECTORY STRUCTURE
```
cert-monitor/
â”œâ”€â”€ .git/
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ cert-monitor/
â”‚       â””â”€â”€ main.go
â”œâ”€â”€ images/
â”‚   â”œâ”€â”€ icon-128.png
â”‚   â”œâ”€â”€ icon-16.png
â”‚   â””â”€â”€ icon-48.png
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ checker/
â”‚   â”‚   â””â”€â”€ checker.go
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ config.go
â”‚   â”œâ”€â”€ evaluator/
â”‚   â”‚   â””â”€â”€ evaluator.go
â”‚   â””â”€â”€ notifier/
â”‚       â””â”€â”€ slack.go
â”œâ”€â”€ .gitignore
â”œâ”€â”€ README.md
â”œâ”€â”€ background.js
â”œâ”€â”€ cert-monitor
â”œâ”€â”€ cert-monitor.exe
â”œâ”€â”€ checking.html
â”œâ”€â”€ checking.js
â”œâ”€â”€ config.toml
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ manifest.json
â”œâ”€â”€ popup.html
â”œâ”€â”€ popup.js
â””â”€â”€ source_dump.txt
```

## FILE CONTENTS

### background.js
```js
// File: background.js
const API_ENDPOINT = 'http://localhost:8080/check-cert';

// Cache dÃ¹ng cho Passive Mode (TOFU)
const certCache = {}; 
// Cache dÃ¹ng cho Strict Mode (Whitelist cÃ¡c trang Ä‘Ã£ qua phÃ²ng cÃ¡ch ly)
const safeSessionCache = {}; 

// --- PHáº¦N 1: LOGIC CHáº¶N Cá»¦A STRICT MODE ---
function shouldIntercept(url) {
    try {
        const urlObj = new URL(url);
        // Chá»‰ cháº·n HTTPS vÃ  khÃ´ng cháº·n trang ná»™i bá»™ extension
        if (urlObj.protocol !== 'https:') return false;
        if (url.startsWith(chrome.runtime.getURL(""))) return false;

        const hostname = urlObj.hostname;
        
        // Náº¿u Ä‘Ã£ náº±m trong whitelist (Ä‘Ã£ check an toÃ n trong 10 phÃºt)
        if (safeSessionCache[hostname] && (Date.now() - safeSessionCache[hostname] < 600000)) {
            return false;
        }
        return true;
    } catch (e) { return false; }
}

// Láº¯ng nghe sá»± kiá»‡n chuyá»ƒn trang (Navigation)
chrome.tabs.onUpdated.addListener((tabId, changeInfo, tab) => {
    // Khi trang báº¯t Ä‘áº§u load
    if (changeInfo.status === 'loading' && tab.url) {
        
        // Kiá»ƒm tra xem ngÆ°á»i dÃ¹ng Ä‘ang Báº­t hay Táº¯t Strict Mode
        chrome.storage.sync.get(['strictMode'], function(result) {
            if (result.strictMode) {
                // [STRICT MODE] -> Kiá»ƒm tra cháº·n
                if (shouldIntercept(tab.url)) {
                    console.log("[Strict Mode] Intercepting: " + tab.url);
                    const checkingUrl = chrome.runtime.getURL('checking.html') + 
                                        `?target=${encodeURIComponent(tab.url)}`;
                    chrome.tabs.update(tabId, { url: checkingUrl });
                }
            } else {
                // [PASSIVE MODE] -> Chá»‰ check ngáº§m, khÃ´ng cháº·n
                // Gá»i hÃ m check Ä‘á»ƒ cáº­p nháº­t icon badge
                if (tab.url.startsWith('https')) {
                    checkAndSendResult(tab.url, tabId);
                }
            }
        });
    }
});

// Nháº­n tin nháº¯n tá»« "PhÃ²ng cÃ¡ch ly" (checking.js)
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
    if (request.action === "mark_as_safe") {
        const hostname = new URL(request.url).hostname;
        safeSessionCache[hostname] = Date.now(); // ThÃªm vÃ o whitelist
        sendResponse({status: "ok"});
    }

    if (request.action === "validate_tofu") {
        const domain = request.domain;
        const newFingerprint = request.fingerprint;
        
        let isSafe = true;
        let error = "";

        // So sÃ¡nh vá»›i Cache trong Background
        if (certCache[domain]) {
            if (certCache[domain] !== newFingerprint) {
                isSafe = false;
                error = "Fingerprint mismatch with Local Cache (TOFU)!";
            }
        } else {
            // Náº¿u chÆ°a cÃ³ thÃ¬ lÆ°u luÃ´n (Trust First Use)
            certCache[domain] = newFingerprint;
        }

        sendResponse({ isSafe: isSafe, error: error });
        return true; // Giá»¯ káº¿t ná»‘i async
    }
});


// --- PHáº¦N 2: LOGIC KIá»‚M TRA & TOFU (DÃ¹ng cho cáº£ Passive & Popup) ---
async function checkAndSendResult(url, tabId) {
    let result = {
        issuer: "Checking...",
        securityScore: 0,
        riskLevel: "UNKNOWN",
        isMITM: false,
        error: null
    };

    try {
        const hostname = new URL(url).hostname;

        // Gá»i API Go Server
        const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ domain: hostname })
        });

        if (!response.ok) throw new Error("Agent Connection Failed");

        const apiData = await response.json();

        if (apiData.error) throw new Error(apiData.error);

        // Map dá»¯ liá»‡u
        result.issuer = apiData.issuer;
        result.expiryDate = new Date(apiData.expiryDate).toLocaleDateString();
        result.daysLeft = apiData.daysLeft;
        result.securityScore = apiData.security_score;
        result.riskLevel = apiData.risk_level;
        result.fingerprint = apiData.fingerprint;
        result.signatureAlgorithm = apiData.signatureAlgorithm;
        result.shouldAlert = apiData.shouldAlert;

        // TOFU Logic (Trust On First Use)
        if (certCache[hostname]) {
            if (certCache[hostname] !== result.fingerprint) {
                result.isMITM = true;
                result.error = "Certificate Fingerprint changed!";
                result.shouldAlert = true;
                result.securityScore = 0;
            }
        } else {
            certCache[hostname] = result.fingerprint;
        }

    } catch (e) {
        console.error(e);
        result.error = e.message;
    }

    // Gá»­i káº¿t quáº£ vá» Popup (náº¿u Ä‘ang má»Ÿ)
    chrome.runtime.sendMessage({
        action: "cert_status_update",
        ...result
    }).catch(() => {});

    // Cáº­p nháº­t Badge trÃªn Icon
    updateBadge(tabId, result);
}

function updateBadge(tabId, result) {
    let color = '#00AA00'; // Xanh
    let text = result.securityScore ? result.securityScore.toString() : "";

    if (result.isMITM) {
        color = '#FF0000'; text = "MITM";
    } else if (result.shouldAlert || result.riskLevel === 'CRITICAL') {
        color = '#FF0000'; text = "!";
    } else if (result.riskLevel === 'WARNING') {
        color = '#FFA500'; 
    }

    chrome.action.setBadgeBackgroundColor({ color: color });
    chrome.action.setBadgeText({ tabId: tabId, text: text });
}

// Láº¯ng nghe yÃªu cáº§u tá»« Popup
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
    if (request.action === "request_cert_check") {
        checkAndSendResult(request.url, request.tabId);
        return true;
    }
});
```

### checking.js
```js
// File: checking.js
const API_ENDPOINT = 'http://localhost:8080/check-cert';

const params = new URLSearchParams(window.location.search);
const targetUrl = params.get('target');

if (targetUrl) {
    performCheck();
} else {
    document.body.innerHTML = "<h1>Invalid Target URL</h1>";
}

async function performCheck() {
    try {
        const hostname = new URL(targetUrl).hostname;

        // BÆ¯á»šC 1: Gá»i Go Server (Check Ä‘iá»ƒm sá»‘ & Risk)
        const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ domain: hostname })
        });

        if (!response.ok) throw new Error("Agent connection failed");
        const data = await response.json();

        // Check sÆ¡ bá»™ tá»« Server
        if (data.security_score < 50 || data.risk_level === 'CRITICAL') {
            showBlockScreen(hostname, data.error || "Low Security Score", data.security_score);
            return; // Dá»«ng ngay
        }

        // BÆ¯á»šC 2: ==> THÃŠM Má»šI: Há»i Background xem cÃ³ khá»›p Cache (TOFU) khÃ´ng?
        chrome.runtime.sendMessage({ 
            action: "validate_tofu", 
            domain: hostname,
            fingerprint: data.fingerprint 
        }, (tofuResult) => {
            
            if (tofuResult.isSafe) {
                // --- Cáº¢ 2 Äá»€U OK: Server OK + Cache OK ---
                // BÃ¡o whitelist vÃ  chuyá»ƒn trang
                chrome.runtime.sendMessage({ action: "mark_as_safe", url: targetUrl }, () => {
                    window.location.replace(targetUrl);
                });
            } else {
                // --- SERVER OK NHÆ¯NG CACHE SAI (MITM) ---
                showBlockScreen(hostname, tofuResult.error, 0);
            }
        });

    } catch (e) {
        showBlockScreen(new URL(targetUrl).hostname, e.message, 0);
    }
}

function showBlockScreen(domain, error, score) {
    document.getElementById('loading-view').classList.add('hidden');
    document.getElementById('blocked-view').classList.remove('hidden');
    document.getElementById('main-card').classList.add('blocked');
    
    document.getElementById('target-domain').textContent = domain;
    document.getElementById('error-reason').textContent = error;
    document.getElementById('security-score').textContent = score;
}
```

### popup.js
```js
// File: popup.js
document.addEventListener('DOMContentLoaded', function() {
    const statusDiv = document.getElementById('status');
    const strictToggle = document.getElementById('strictModeToggle');
  
    // 1. Load tráº¡ng thÃ¡i Strict Mode tá»« bá»™ nhá»›
    chrome.storage.sync.get(['strictMode'], function(result) {
        strictToggle.checked = result.strictMode || false;
    });
  
    // 2. Láº¯ng nghe sá»± kiá»‡n Báº­t/Táº¯t Switch
    strictToggle.addEventListener('change', function() {
        const isStrict = strictToggle.checked;
        chrome.storage.sync.set({ strictMode: isStrict }, function() {
            console.log("Strict Mode set to " + isStrict);
            // Reload tab hiá»‡n táº¡i Ä‘á»ƒ Ã¡p dá»¥ng ngay láº­p tá»©c
            chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
                if(tabs[0]) chrome.tabs.reload(tabs[0].id);
            });
        });
    });
  
    // 3. Logic hiá»ƒn thá»‹ thÃ´ng tin cÅ©
    statusDiv.innerHTML = "<p>Connecting to Hybrid Agent...</p>"; 
  
    chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
        if (request.action === "cert_status_update") {
          renderResult(request);
        }
    });
  
    chrome.tabs.query({ active: true, currentWindow: true }, function(tabs) {
      if (tabs[0] && tabs[0].url.startsWith("https")) {
        chrome.runtime.sendMessage({ 
            action: "request_cert_check", 
            url: tabs[0].url,
            tabId: tabs[0].id
        });
      } else {
        statusDiv.innerHTML = "<p style='color:gray; padding:10px;'>Please verify an HTTPS website.</p>";
      }
    });
  });
  
  function renderResult(data) {
      const statusDiv = document.getElementById('status');
      
      let scoreColor = '#2ecc71'; // Green
      if (data.securityScore < 50) scoreColor = '#e74c3c'; // Red
      else if (data.securityScore < 80) scoreColor = '#f39c12'; // Orange
  
      let html = `
          <div style="text-align: center; padding: 15px; background: #f9f9f9; border-bottom: 1px solid #eee;">
              <div style="font-size: 36px; color: ${scoreColor}; font-weight: bold;">
                  ${data.securityScore !== undefined ? data.securityScore : "?"}
              </div>
              <div style="font-size: 12px; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px;">Security Score</div>
          </div>
      `;
  
      if (data.isMITM) {
          html += `
              <div style="background-color: #c0392b; color: white; padding: 10px; margin: 10px 0; font-weight: bold; text-align: center; border-radius: 4px;">
                  ğŸš¨ MITM ATTACK DETECTED ğŸš¨
                  <div style="font-size: 10px; font-weight: normal;">Certificate fingerprint mismatch!</div>
              </div>
          `;
      } else if (data.error) {
          html += `<div style="color: #c0392b; padding: 10px; font-size: 12px;">Error: ${data.error}</div>`;
      }
  
      if (data.issuer) {
          html += `
              <div style="padding: 15px; font-size: 13px; line-height: 1.6;">
                  <div><strong>Issuer:</strong> ${data.issuer}</div>
                  <div><strong>Expires:</strong> ${data.expiryDate}</div>
                  <div><strong>Days Left:</strong> <span style="color:${data.daysLeft < 30 ? 'red' : 'green'}">${data.daysLeft}</span></div>
                  <div><strong>Algorithm:</strong> ${data.signatureAlgorithm}</div>
                  <div style="margin-top: 8px; font-size: 10px; color: #95a5a6; word-break: break-all;">
                      <strong>Fingerprint (SHA256):</strong><br>
                      ${data.fingerprint ? data.fingerprint.substring(0, 20) + "..." : "N/A"}
                  </div>
              </div>
          `;
      }
  
      statusDiv.innerHTML = html;
  }
```
